version: '3.4'
services:
  collector:
    # hopefully 0.27.0 will include polling exporter
    # image: quay.io/signalfx/splunk-otel-collector:0.27.0
    image: ghcr.io/splunk-o11y-gdi-bot/splunk-otel-collector-dev:polling
    environment:
      - SPLUNK_CONFIG=/etc/otel/config.yml
    volumes:
      - ./collector.config.yml:/etc/otel/config.yml
    # ports:
    #   - "55681:55681" # HTTP OTLP
    #   - "4317:4317" # GRPC OTLP
    #   - "8378:8378" # POLLING
    #   - "13133:13133" # HEALTH CHECK
  app:
    build:
      context:  ../../
      dockerfile: test/examples/Dockerfile
      # target: published # enable to run tests on published package instead of the one compiled from source
    working_dir: /home/node/app/examples/basic
    # TODO: use env file
    environment:
      - PORT=80
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:55681/v1/traces
  test:
    build:
      context: .
      target: base
    command: node ./basic
    # volumes:
    #   - ./:/home/node/app # for local iteration
    environment:
      - REQ_URL=http://app/hello
      - COLLECTOR_URL=http://collector:8378
    depends_on:
      - app
      - collector
