default:
  image: 'cimg/node:lts'

#cache:
#  key:
#    files:
#      - package-lock.json
#  paths:
#    - .npm/
#    - node_modules/

# tell npm to store cache in .npm so it can be cached by Gitlab
#before_script:
#  - npm ci --ignore-scripts --cache .npm --prefer-offline

stages:
  - setup
  - build
  - test
  - release

install:
  stage: setup
  script:
    - npm install

test:
  script:
    - npm test

lint:
  script:
    - npm run lint
    - npm run version:check

build-linux-node10:
  stage: build
  image: node:10.12.0
  script:
    - npm install
    - npm run prebuild:os 8.5.0 9.0.0 10.0.0 11.0.0 12.0.0 13.0.0
    - npm test
  artifacts:
    name: linux-node10
    paths:
      - "prebuilds"

build-linux-node14:
  stage: build
  image: node:14.0.0
  script:
    - npm install
    - npm run prebuild:os 14.0.0 15.0.0 16.0.0
    - npm test
    - touch foobar.txt
  artifacts:
    name: linux-node14
    paths:
      - "prebuilds"
      - "foobar.txt"

build:
  needs:
    - build-linux-node10
    - build-linux-node14
  artifacts:
    paths:
      - dist/
  script:
    - ls -la
    - npm run compile
    - npm pack

release:
  stage: release
  artifacts:
    paths:
      - dist/
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+.*/
  except:
    - branches
  script:
    - npm install
    - npm run compile
    - npm pack
    - mkdir -p dist
    - mv splunk-otel-${CI_COMMIT_REF_NAME:1}.tgz dist/
    - shasum -a 256 dist/* > dist/checksums.txt

    # release in Github
    - npm run release:github

    # release in NPM
    - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
    - npm publish ./dist/splunk-otel-${CI_COMMIT_REF_NAME:1}.tgz
    - rm -f ~/.npmrc
